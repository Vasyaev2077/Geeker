# Generated by Django 5.1.2 on 2026-01-24

from django.db import migrations, models
import django.db.models.deletion


def backfill_section_collections(apps, schema_editor):
    Section = apps.get_model("library", "Section")
    Collection = apps.get_model("library", "Collection")

    # Visibility enum values are stored as strings
    for s in Section.objects.filter(collection__isnull=True).iterator():
        c = Collection.objects.create(
            owner=s.owner,
            title=s.name,
            description=s.description or "",
            visibility="private",
            is_archived=False,
        )
        s.collection = c
        s.save(update_fields=["collection"])


class Migration(migrations.Migration):
    dependencies = [
        ("library", "0002_section_item_sections"),
    ]

    operations = [
        migrations.AddField(
            model_name="section",
            name="description",
            field=models.TextField(blank=True),
        ),
        migrations.AddField(
            model_name="section",
            name="cover",
            field=models.ImageField(blank=True, null=True, upload_to="sections/"),
        ),
        migrations.AddField(
            model_name="section",
            name="collection",
            field=models.OneToOneField(
                blank=True,
                null=True,
                on_delete=django.db.models.deletion.CASCADE,
                related_name="section",
                to="library.collection",
            ),
        ),
        migrations.RunPython(backfill_section_collections, migrations.RunPython.noop),
    ]

