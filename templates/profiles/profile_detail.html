{% extends "base/base_app.html" %}
{% load i18n static %}

{% block title %}{% trans "Profile" %}{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'js/profile_posts.js' %}"></script>
{% endblock %}

{% block app_content %}
<div class="profile-layout">
  <div class="profile-left">
    <div class="profile-avatar">
      {% if object.avatar %}
        <img src="{{ object.avatar.url }}" alt="{{ object.display_name }}">
      {% else %}
        <span class="profile-avatar-initial">{{ request.user.username|first|upper }}</span>
      {% endif %}
    </div>
    <div class="profile-username">
      <span class="profile-username-label">user/</span>{{ object.display_name }}
      <a href="{% url 'profiles:edit' %}" class="profile-edit-link">‚úé</a>
      <a href="{% url 'profiles:settings' %}" class="profile-settings-link">‚öô</a>
    </div>
  </div>
  <div class="profile-center">
    <div class="profile-feed-header">
      <button type="button" class="btn btn-muted profile-create-post-btn" data-open-post-modal="create">
        + {% trans "–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç" %}
      </button>
    </div>

    <div class="profile-feed">
      {% for post in posts %}
        <article class="post-card" data-post-id="{{ post.id }}" id="post-{{ post.id }}">
          <script type="application/json" id="post-media-json-{{ post.id }}">
            [
            {% for m in post.media_items.all %}
              {% if forloop.counter0 < 8 %}
                {"id": {{ m.id }}, "url": "{{ m.file.url }}"}{% if not forloop.last %},{% endif %}
              {% endif %}
            {% endfor %}
            ]
          </script>
          <div class="post-header">
            <div class="post-author">
              <div class="post-author-avatar">
                {% if object.avatar %}
                  <img src="{{ object.avatar.url }}" alt="{{ object.display_name }}">
                {% else %}
                  <span class="profile-avatar-initial">{{ request.user.username|first|upper }}</span>
                {% endif %}
              </div>
              <div class="post-author-meta">
                <div class="post-author-name">{{ object.display_name }}</div>
                <div class="post-date">{{ post.created_at|date:"d M Y, H:i" }}</div>
              </div>
              {% if post.is_pinned %}
                <div class="post-badge">{% trans "–ó–∞–∫—Ä–µ–ø–ª–µ–Ω–æ" %}</div>
              {% endif %}
            </div>

            <div class="post-menu">
              <button type="button" class="post-menu-btn" aria-label="{% trans '–ú–µ–Ω—é' %}" data-post-menu-btn>‚ãØ</button>
              <div class="post-menu-dropdown" hidden>
                <form method="post" action="{% url 'profiles:post_pin' post.id %}">
                  {% csrf_token %}
                  <button type="submit" class="post-menu-item">{% trans "–ó–∞–∫—Ä–µ–ø–∏—Ç—å" %}</button>
                </form>
                <button
                  type="button"
                  class="post-menu-item"
                  data-open-post-modal="edit"
                  data-post-id="{{ post.id }}"
                  data-post-text="{{ post.text|escapejs }}"
                  data-post-edit-url="{% url 'profiles:post_edit' post.id %}"
                >
                  {% trans "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å" %}
                </button>
                <form method="post" action="{% url 'profiles:post_toggle_comments' post.id %}">
                  {% csrf_token %}
                  <button type="submit" class="post-menu-item">
                    {% if post.comments_enabled %}{% trans "–û—Ç–∫–ª—é—á–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏" %}{% else %}{% trans "–í–∫–ª—é—á–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏" %}{% endif %}
                  </button>
                </form>
                <form method="post" action="{% url 'profiles:post_delete' post.id %}">
                  {% csrf_token %}
                  <button type="submit" class="post-menu-item post-menu-danger" data-confirm-delete>
                    {% trans "–£–¥–∞–ª–∏—Ç—å" %}
                  </button>
                </form>
              </div>
            </div>
          </div>

          {% with media_count=post.media_items.count %}
          {% if media_count %}
            <div class="post-carousel" data-carousel data-carousel-count="{{ media_count }}">
              <div class="post-carousel-viewport">
                <div class="post-carousel-track">
                  {% for m in post.media_items.all %}
                    {% if forloop.counter0 < 8 %}
                      <div class="post-carousel-slide">
                        <img class="post-carousel-img" src="{{ m.file.url }}" alt="" data-carousel-img data-post-id="{{ post.id }}" data-index="{{ forloop.counter0 }}">
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </div>
              {% if media_count|add:0 > 1 %}
                <button type="button" class="post-carousel-nav post-carousel-prev" data-carousel-prev aria-label="{% trans '–ù–∞–∑–∞–¥' %}">‚Äπ</button>
                <button type="button" class="post-carousel-nav post-carousel-next" data-carousel-next aria-label="{% trans '–í–ø–µ—Ä—ë–¥' %}">‚Ä∫</button>
                <div class="post-carousel-dots" data-carousel-dots>
                  {% for m in post.media_items.all %}
                    {% if forloop.counter0 < 8 %}
                      <button type="button" class="post-carousel-dot" data-carousel-dot data-index="{{ forloop.counter0 }}" aria-label="{{ forloop.counter }}"></button>
                    {% endif %}
                  {% endfor %}
                </div>
              {% endif %}
            </div>
          {% endif %}
          {% endwith %}

          {% if post.text %}
            {% if post.text|length > 500 %}
              <div class="post-text">
                <div class="post-text-short">{{ post.text|slice:":500"|linebreaksbr }}‚Ä¶</div>
                <div class="post-text-full" hidden>{{ post.text|linebreaksbr }}</div>
                <button type="button" class="post-text-toggle" data-post-text-toggle>{% trans "–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å" %}</button>
              </div>
            {% else %}
              <div class="post-text">{{ post.text|linebreaksbr }}</div>
            {% endif %}
          {% endif %}

          {% if not post.comments_enabled %}
            <div class="post-note">{% trans "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã" %}</div>
          {% endif %}

          <div class="post-actions">
            <div class="post-votes">
              <form method="post" action="{% url 'profiles:post_vote' post.id %}">
                {% csrf_token %}
                <input type="hidden" name="value" value="1">
                <button type="submit" class="post-vote-btn {% if post.current_user_votes and post.current_user_votes.0.value == 1 %}post-vote-active{% endif %}" data-vote-btn="1" aria-label="{% trans '–ì–æ–ª–æ—Å –≤–≤–µ—Ä—Ö' %}">‚Üë</button>
              </form>
              <div class="post-vote-score">{{ post.vote_score|default:0 }}</div>
              <form method="post" action="{% url 'profiles:post_vote' post.id %}">
                {% csrf_token %}
                <input type="hidden" name="value" value="-1">
                <button type="submit" class="post-vote-btn {% if post.current_user_votes and post.current_user_votes.0.value == -1 %}post-vote-active{% endif %}" data-vote-btn="-1" aria-label="{% trans '–ì–æ–ª–æ—Å –≤–Ω–∏–∑' %}">‚Üì</button>
              </form>
            </div>

            <button type="button" class="post-action-btn" data-post-comments-toggle>
              üí¨ <span class="post-action-count">{{ post.comments_count|default:0 }}</span>
            </button>
            <button type="button" class="post-action-btn" data-post-share data-post-share-url="#post-{{ post.id }}">
              ‚Üó {% trans "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è" %}
            </button>
          </div>

          <div class="post-comments" hidden>
            {% if post.comments_enabled %}
              <form method="post" action="{% url 'profiles:post_comment_create' post.id %}" class="post-comment-form">
                {% csrf_token %}
                <input type="text" name="text" maxlength="2000" class="post-comment-input" placeholder="{% trans '–ù–∞–ø–∏—à–∏—Ç–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π‚Ä¶' %}">
                <button type="submit" class="btn btn-primary">{% trans "–û—Ç–ø—Ä–∞–≤–∏—Ç—å" %}</button>
              </form>
            {% else %}
              <div class="post-note">{% trans "–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã" %}</div>
            {% endif %}
          </div>
        </article>
      {% empty %}
        <div class="post-empty">
          {% trans "–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ—Å—Ç–æ–≤. –ù–∞–∂–º–∏—Ç–µ ¬´–°–æ–∑–¥–∞—Ç—å –ø–æ—Å—Ç¬ª." %}
        </div>
      {% endfor %}

      {% include "base/_pagination.html" %}
    </div>
  </div>
  <div class="profile-right">
    <div class="profile-widget">
      <p>{% trans "–ó–¥–µ—Å—å –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–∏–¥–∂–µ—Ç —Å –ª—é–±–∏–º–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π –∏–ª–∏ –≤–Ω–µ—à–Ω–∏–º –ø—Ä–æ—Ñ–∏–ª–µ–º." %}</p>
    </div>
  </div>
</div>

<div id="lightbox" class="lightbox" hidden aria-hidden="true">
  <div class="lightbox-backdrop" data-lightbox-close></div>
  <button type="button" class="lightbox-close" data-lightbox-close aria-label="{% trans '–ó–∞–∫—Ä—ã—Ç—å' %}">√ó</button>
  <button type="button" class="lightbox-nav lightbox-prev" data-lightbox-prev aria-label="{% trans '–ù–∞–∑–∞–¥' %}">‚Äπ</button>
  <button type="button" class="lightbox-nav lightbox-next" data-lightbox-next aria-label="{% trans '–í–ø–µ—Ä—ë–¥' %}">‚Ä∫</button>
  <div class="lightbox-counter" id="lightbox-counter"></div>
  <img id="lightbox-img" class="lightbox-img" alt="">
</div>

<div id="post-modal" class="modal" hidden aria-hidden="true">
  <div class="modal-backdrop" data-post-close></div>
  <div class="modal-dialog post-modal-dialog" role="dialog" aria-modal="true" aria-labelledby="post-modal-title">
    <div class="modal-header">
      <h3 id="post-modal-title">{% trans "–ù–æ–≤—ã–π –ø–æ—Å—Ç" %}</h3>
      <button type="button" class="modal-close" data-post-close aria-label="{% trans '–ó–∞–∫—Ä—ã—Ç—å' %}">√ó</button>
    </div>
    <form id="post-form" method="post" enctype="multipart/form-data" action="{% url 'profiles:post_create' %}">
      {% csrf_token %}
      <input type="hidden" name="deleted_media_ids" id="deleted-media-ids" value="">
      <div class="modal-body post-modal-body">
        <div class="post-upload">
          <input id="post-media-input" type="file" name="media" accept="image/*" multiple hidden>
          <button type="button" class="post-upload-drop" data-post-pick>
            <div class="post-upload-icon">‚Üë</div>
            <div class="post-upload-title">{% trans "–î–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –≤–∏–¥–µ–æ" %}</div>
            <div class="post-upload-btn">{% trans "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞" %}</div>
          </button>
          <div id="post-media-preview" class="post-upload-grid" hidden></div>
        </div>
        <textarea name="text" id="post-text" class="post-textarea" rows="3" maxlength="2000" placeholder="{% trans '–ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å...' %}"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn" data-post-close>{% trans "–û—Ç–º–µ–Ω–∞" %}</button>
        <button type="submit" class="btn btn-primary">{% trans "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å" %}</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}






